(()=>{var e={};e.id=4950,e.ids=[4950],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11735:(e,r,t)=>{"use strict";t.d(r,{A:()=>n,z:()=>a});var s=t(96330);let a=global.prisma||new s.PrismaClient,n=a},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},95006:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>m,routeModule:()=>f,serverHooks:()=>x,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>w});var s={};t.r(s),t.d(s,{GET:()=>l,POST:()=>p,PUT:()=>v});var a=t(96559),n=t(48088),i=t(37719),o=t(32190),c=t(11735);let d=e=>{if(e&&0!==e.length)return e.reduce((r,t)=>(r[t.vehicleId]||(r[t.vehicleId]={id:t.vehicleId,vehicleKeys:e.filter(e=>e.vehicleId===t.vehicleId)}),r),{})};async function u(){return(await c.z.vehicleKey.findMany({orderBy:{createdAt:"desc"},select:{id:!0,status:!0,vehicleId:!0,user:{select:{name:!0}},vehicle:{select:{plate:!0,model:!0}}},distinct:["vehicleId"]})).map(e=>({id:e.id,user:e.user.name,vehicle:e.vehicle.plate+" - "+e.vehicle.model,status:e.status,vehicleId:e.vehicleId}))}async function l(e){try{let[e,r,t]=await c.z.$transaction([c.z.user.findMany({orderBy:{name:"asc"},select:{id:!0,name:!0}}),c.z.vehicle.findMany({orderBy:{plate:"asc"},select:{id:!0,plate:!0,model:!0}}),c.z.vehicleKey.findMany({select:{id:!0,status:!0,user:{select:{name:!0}},vehicle:{select:{plate:!0,model:!0}},createdAt:!0,updatedAt:!0,vehicleId:!0,userId:!0,parentId:!0},orderBy:{createdAt:"desc"}})]),s=d(t),a=await u();return o.NextResponse.json({users:e,vehicles:r,grouped:s,last:a})}catch(e){return console.error("Error fetching data:",e),o.NextResponse.json({error:"Error fetching data"},{status:500})}}async function p(e){try{let{userId:r,vehicleId:t,parentId:s,newUser:a}=await e.json();if(!r||!t)return o.NextResponse.json({error:"Missing required fields"},{status:400});let n=await c.z.$transaction(async e=>{if(!await e.user.findUnique({where:{id:r}}))throw Error("User not found");if(!await e.vehicle.findUnique({where:{id:t}}))throw Error("Vehicle not found");return s&&await e.vehicleKey.update({where:{id:s},data:{status:"CONFIRMED"}}),await e.vehicleKey.create({data:{userId:r,vehicleId:t,parentId:s,status:a?"CONFIRMED":"PENDING"}})});return o.NextResponse.json(n,{status:201})}catch(e){return console.error("Error creating transfer:",e),o.NextResponse.json({error:"Error creating transfer"},{status:500})}}async function h(e){let{id:r,userId:t}=e;return c.z.$transaction(async e=>{try{let s=await e.vehicleKey.findUnique({where:{id:r}});if(!s)throw Error("Transfer\xeancia n\xe3o encontrada");if("PENDING"!==s.status)throw Error("Transfer\xeancia n\xe3o est\xe1 pendente");let a=await e.vehicleKey.update({where:{id:r},data:{status:"CONFIRMED",updatedAt:new Date}});return await e.vehicleKey.create({data:{userId:t,status:"CONFIRMED",parentId:a.id||null,vehicleId:a.vehicleId}})}catch(e){throw e}})}async function v(e){try{let r=await e.json(),t=await h(r);return o.NextResponse.json(t)}catch(e){return console.error("Error confirming transfer:",e),o.NextResponse.json({error:"Error confirming transfer"},{status:500})}}let f=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/v2/dashboard/keys/route",pathname:"/api/v2/dashboard/keys",filename:"route",bundlePath:"app/api/v2/dashboard/keys/route"},resolvedPagePath:"C:\\Users\\carlos.dias\\Documents\\repositorio\\checklist\\src\\app\\api\\v2\\dashboard\\keys\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:y,workUnitAsyncStorage:w,serverHooks:x}=f;function m(){return(0,i.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:w})}},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{},96559:(e,r,t)=>{"use strict";e.exports=t(44870)}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[80],()=>t(95006));module.exports=s})();